---
title: "Amplicon Sequence Analyses after Antibiotic Treatment"
subtitle: "faecal and Faecal ANCOM-BC2 Analysis"
author: "Julius Nweze"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    keep_md: true
    number_sections: false
    highlight: "pygments"
    theme: "flatly"
    dev: "png"
    df_print: "kable"
    fig_caption: true
    code_folding: "show"
editor_options: 
  chunk_output_type: console
---

```{r libraries, include=F}
# Load libraries
#.libPaths(c('~/R/library', .libPaths())) # Uncomment if you have no write access to R path

repo <- "http://cran.wu.ac.at"
lib.loc <- Sys.getenv("R_LIBS_USER")

update.packages(
    lib.loc, 
    repos = repo,
    ask = FALSE
)

.cran_libs <- c(
  "phyloseq", # a set of classes and tools to facilitate the import, storage, analysis, and graphical display of microbiome census data
  "rmarkdown", # Dynamic Documents for R
  "knitr",  # A General-Purpose Package for Dynamic Report Generation in R
  "extrafont", # for extra figure fonts
  "phyloseq.extended", # Various customs functions written to enhance the base functions of phyloseq
  "dplyr",  # filter and reformat data frames
  "gridExtra", # To arrange multiple grid-based plots on a page, and draw tables.
  "knitr", # A General-Purpose Package for Dynamic Report Generation in R
  "kableExtra", # Construct Complex Table with 'kable' and Pipe Syntax
  "rmarkdown", # Dynamic Documents for R
  "extrafont", # for extra figure fonts
  "tidyverse", # for dplyr forcats ggplot2 readr tibble
  "grid", # The Grid Graphics Package
  "magrittr", # pipes
  "scales", # Generic plot scaling methods
  "svglite", # for svg files
  "vegan",  # Ordination methods, diversity analysis and other functions for community and vegetation ecologists
  "car", # Companion to Applied Regression
  "rcompanion", #Functions to Support Extension Education Program Evaluation
  "multcomp", # Simultaneous Inference in General Parametric Models 
  "nlme", # Fit Linear Model Using Generalized Least Squares
  "ggResidpanel", # Panels and Interactive Versions of Diagnostic Plots using 
  "lsmeans", # Least-Squares Means
  "ggplot2",      # graphics
  "tidyr", # necessary to import the data from Excel file
  "phyloseqGraphTest", # Provides functions for graph-based multiple-sample testing and visualization of microbiome data
  "shiny", # makes it easy to build interactive web apps straight from R
  "miniUI", # Designed to work especially well for creating Shiny Gadgets
  "caret", # Classification And REgression Training is a set of functions that attempt to streamline the process for creating predictive models
  "pls", # Partial Least Squares and Principal Component Regression
  "e1071", # Functions for latent class analysis, short time Fourier transform, fuzzy clustering, support vector machines
  "randomForest",
  "ggrepel",
  "dunn.test",
  "reshape2",
  "readODS",
  "devtools",
  "micro4all",
  "PMA", 
    # "structSSI",  
  "ade4",
  "igraph", 
  "ggnetwork", 
  "intergraph",
  "DT", 
  "scales",
  "mia",
  "microbiome",
  "ggpubr",
  "RColorBrewer",
  "microbiomeutilities",
  "viridis",
  "tibble",
  "ANCOMBC",
  "cowplot",
  "userfriendlyscience",
# "agricolae", # Statistical Procedures for Agricultural Research
 # "doParallel", # parallel backend for the foreach/%dopar% function
 "BiodiversityR", # Package for Community Ecology and Suitability Analysis
 # "hexbin", # Hexagonal Binning Routines
 # "ggtern", # An Extension to 'ggplot2', for the Creation of Ternary Diagrams
#  "MuMIn" # Multi-Model Inference
  #"stringr",
 # "mctoolsr"
"AnnotationDbi", 
"DESeq2", 
"GO.db", 
"impute", 
"preprocessCore",
"adespatial"
) 

.inst <- .cran_libs %in% installed.packages()
if (any(!.inst)) {
   install.packages(.cran_libs[!.inst],
                    repos = repo,
                    lib = lib.loc)
}

.bioc_libs <- c(
  #"multtest", #Resampling-based multiple hypothesis testing
)

.bioc_inst <- .bioc_libs %in% installed.packages()
if (any(!.bioc_inst)) {
   if (!requireNamespace("BiocManager", quietly = TRUE))
   install.packages("BiocManager")
   BiocManager::install(ask = F, lib = lib.loc)  # upgrade bioC packages
   BiocManager::install(.bioc_libs[!.bioc_inst], ask = F, lib = lib.loc)
}

.local_libs <- c()

.inst <- names(.local_libs) %in% installed.packages()
if (any(!.inst)) {
   install.packages(paste0("~/R/", .local_libs[!.inst]) ,repos = NULL, type = "source", lib = lib.loc)
}

.github_libs <- c()

.github_lib_names <- stringr::str_replace(.github_libs, ".*/(.*)$", "\\1")

.github_inst <- .github_lib_names %in% installed.packages()
if (any(!.github_inst)) {
  devtools::install_github(.github_libs[!.github_inst],
                           lib = lib.loc,
                           dependencies = TRUE)
}


# Load packages into session, and print package version
(loaded.libs <- sapply(c(.cran_libs, .bioc_libs, names(.local_libs), .github_lib_names), require, character.only = TRUE))
if (!all(loaded.libs)) {stop(paste("Package(s):", names(loaded.libs[loaded.libs == FALSE]), "could not be loaded"))}
sapply(c(.cran_libs, .bioc_libs, names(.local_libs), .github_lib_names), packageVersion)
set.seed(123456789)
bootstraps <- 1000
min_lib_size <- 1000
```


```{r style settings, include=F}
graphic_device <- "svglite"
options(width = 90, knitr.table.format = "html") 
opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  cache = TRUE,
  dev = graphic_device,
  fig.ext = "svg",
  #  fig.width=12,
  #  fig.height=8,
  cache.path = "Antibiotics_Sequence_cache/",
  fig.path = "Antibiotics_Sequence_figures/"
)

f_name <- "DejaVu Sans" #sub("\\s//", "", f_name)
f_size <- 12
font_import(pattern = "DejaVuSans", prompt = FALSE)
loadfonts() # registers fonts
theme_set(theme_bw(base_size = f_size, base_family = f_name))
pom4 <- ggpomological:::pomological_palette[c(2, 1, 9, 3)]
pom2 <- c(ggpomological:::pomological_base[[7]], ggpomological:::pomological_palette[[1]])
```

```{r functions, include=F}
#' Filter ASVs by Count and Presence in a Phyloseq Object
#' Filter ASVs by count number and presence in a phyloseq object based on specified thresholds.
#'
#' @param physeq A phyloseq object that has sample indices.
#'
#' @param abund_thresh The abundance threshold for filtering ASVs. ASVs with counts below this threshold will be removed.
#'
#' @param prev_thresh The prevalence threshold for filtering ASVs. ASVs must be present in at least this many samples to be retained.
#'
#' @param var2split A single character string matching a variable name in the corresponding sample_data of `physeq`.
#'                  If provided, ASVs will be filtered separately for each level of the specified variable.
#'                  Default: ""
#'
#' @return A filtered phyloseq object with ASVs meeting the specified abundance and prevalence thresholds.
#'
#' @author Roey Angel (https://github.com/roey-angel)
#'
#' @usage filter_ASVs_by_prevalence(physeq, abund_thresh = 10, prev_thresh = 6, var2split = "")
#'
#' @seealso \code{\link{filter_taxa_by_prevalence}}
#'
#' @export
#' 
filter_ASVs_by_prevalence <- function (ps_obj, abund_thresh = 10, prev_thresh = 6, var2split = "") {
  # Filter ASVs by count number and presence in a phyloseq object
  # var2split <<- vars2test 
  trans <- FALSE
  if(taxa_are_rows(ps_obj)) {
    trans <- TRUE
    ps_obj <- t(ps_obj)}
  
  if(!is.na(var2split) & var2split != "") {
    split_levels <- as.character(unique(get_variable(ps_obj, var2split)))

    keep <- taxa_names(ps_obj) %in% taxa_names(ps_obj)
    names(keep) <- taxa_names(ps_obj)
    for (split_level in split_levels){
      split_ps <- ps_obj
      # split_ps <- subset_samples(ps_obj, get(var2split) == split_level) # Indirection is needed here (NSE) but phyloseq is too shitty to accept it!!
      oldDF <- as(sample_data(ps_obj), "data.frame")
      newDF <- subset(oldDF, get({{var2split}}) == split_level) 
      sample_data(split_ps) <- sample_data(newDF)
      otu_tab <- as(otu_table(split_ps), "matrix")
      keep <- keep & (colSums(otu_tab >= abund_thresh) >= prev_thresh)
      #print(keep)
    }

  } else {
    otu_tab <- as(otu_table(ps_obj), "matrix")
    keep <- colSums(otu_tab >= abund_thresh) >= prev_thresh
    #print(keep)
  }
  
  otu_tab <- as(otu_table(ps_obj), "matrix")
  otu_tab <- otu_tab[, keep]
  otu_table(ps_obj) <- otu_table(otu_tab, taxa_are_rows = FALSE)
  if(trans) {ps_obj <- t(ps_obj)}
  return(ps_obj)
}

```


## **Read the data and create both Epibolus (faecal and faecal) phyloseq objects**
```{r load amplicon seq data, cache = T}
tsv_table <- read.table("16_DADA2.seqtab_nochim_decontam.tsv", sep = ",", header = TRUE, quote = "", comment.char = "", stringsAsFactors = FALSE, check.names = FALSE)
tax_table <- read.table("16_DADA2.taxa_silva_decontam.tsv", sep = ",", header = TRUE, quote = "", comment.char = "", stringsAsFactors = FALSE, check.names = FALSE)
sample_table <- read.csv("16_Metadata.csv", sep = ",", header = TRUE, check.names = FALSE)
```


##*Phyloseq objects need to have row.names*
```{r adding row.names to data, cache = T}

# Define the row names from the ASV column
row.names(tsv_table) <- tsv_table$ASV
 tsv_table <- tsv_table %>% dplyr::select(-c(ASV, MC1_S96, BC1_S103, NC1_S110, MC2_S123, BC2_S130, NC2_S137)) 


row.names(tax_table) <- tax_table$ASV
tax_table <- tax_table %>% dplyr::select(-ASV)
  
row.names(sample_table) <- sample_table$Sample
sample_table <- sample_table[!(sample_table$Sample=="MC1_S96" | sample_table$Sample=="BC1_S103" | sample_table$Sample=="NC1_S110" | sample_table$Sample=="MC2_S123" | sample_table$Sample=="BC2_S130" | sample_table$Sample=="NC2_S137"),]
sample_table <- sample_table %>% dplyr::select(-Sample)
```


*Transform into matrixes tsv and tax tables (sample table can be left as data frame)*
```{r transformation of data to matrices, cache = T} 

tsv_table <- as.matrix(tsv_table)
tax_table <- as.matrix(tax_table)
```



*Transform to phyloseq objects*
```{r pyloseq object, cache = T}


OTU <- otu_table(tsv_table, taxa_are_rows = TRUE)
TAX = tax_table(tax_table)
sample = sample_data(sample_table)

carbom <- merge_phyloseq(sample, OTU, TAX)
carbom




# Visualize data

sample_names(carbom)

rank_names(carbom)

sample_variables(carbom)


summarize_phyloseq(carbom)
```


# Faeces from Glomeris connexa

*Group according to sample sources (Epibolus faecal pellets)*
```{r group according to sample sources, cache = T}
# Epibolus faecal pellets
Epi_faecal <- subset_samples(carbom, sample_names(carbom) =="Fp-E1G_S117" | sample_names(carbom) == "Fp-E1H_S118" | sample_names(carbom) == "Fp-E1J_S119" | sample_names(carbom) == "Fp-E2A_S120" | sample_names(carbom) == "Fp-E2D_S121" | sample_names(carbom) == "Fp-E2H_S122" | sample_names(carbom) == "Fp-E3B_S124" | sample_names(carbom) == "Fp-E3E_S125" | sample_names(carbom) == "Fp-E3J_S126" | sample_names(carbom) == "Fp-E4C_S127" | sample_names(carbom) == "Fp-E4B_S128" | sample_names(carbom) == "Fp-E4E_S129")
Epi_faecal

# Phyloseq object Summary
summarize_phyloseq(Epi_faecal)
```



# ALDEX2
```{r ALDEX2, cache = T}
Epi_faecal = subset_taxa(Epi_faecal, Phylum != "unassigned")

significance <- 0.5


# Remove all ASVs that aren't in at least 2 samples or have an abundance of at least 2
Epi_faecal_subset_pairwise_s <- filter_ASVs_by_prevalence(ps_obj = Epi_faecal, 
                                             abund_thresh = 2, 
                                             prev_thresh = 2)



# Define the treatments for pairwise comparisons
treatments_to_compare <- list(
  c("Sterile feed", "Control"),
  c("Antibiotics (2X)", "Control"),
  c("Antibiotics (1X)", "Control"),
  c("Antibiotics (2X)", "Sterile feed"),
  c("Antibiotics (1X)", "Sterile feed"),
  c("Antibiotics (1X)", "Antibiotics (2X)")
)

# Create an empty list to store the results
results_list_Epi_faecal <- list()

# Loop through each pair of treatments
for (pair in treatments_to_compare) {
  treatment1 <- pair[1]
  treatment2 <- pair[2]

  # Subset the data for the pair of treatments
  subset_data_Epi_faecal <- Epi_faecal_subset_pairwise_s %>%
    subset_samples(Treatment %in% c(treatment1, treatment2))
  
  # Mark rare species -------------------------------------------------------
  Epi_faecal_subset_glom <- tax_glom(subset_data_Epi_faecal,
                               "Phylum",
                               NArm = TRUE)
  Epi_faecal_subset_glom_rel <-
    transform_sample_counts(Epi_faecal_subset_glom, function(x)
      x / sum(x))
  Epi_faecal_subset_glom_rel_DF <- psmelt(Epi_faecal_subset_glom_rel)
  Epi_faecal_subset_glom_rel_DF$Phylum %<>% as.character()

  # Group dataframe by Phylum, calculate median rel. abundance
  Epi_faecal_subset_glom_rel_DF %>%
    group_by(Phylum) %>%
    summarise(median = median(Abundance)) ->
    medians

  # Find Phyla whose rel. abundance is less than 0.5%
  Rare_phyla <- medians[medians$median <= 0.004,]$Phylum
  

  # Change their name to "Rare"
  Epi_faecal_subset_glom_rel_DF[Epi_faecal_subset_glom_rel_DF$Phylum %in% Rare_phyla,]$Phylum <-
    'Rare'

  # Regroup
Epi_faecal_subset_glom_rel_DF %>%
  group_by(Phylum) %>%
  summarise(Abundance = sum(Abundance)) %>%
  arrange(desc(Abundance)) -> Taxa_rank


    # Run calc_ALDEx2 for the pair
  ALDEx2plot_pairwise_Epi_faecal <- calc_ALDEx2(
    physeq_obj = subset_data_Epi_faecal,
    vars2test = "Treatment",
    rare_phyla = Rare_phyla,
    sig_level = significance,
    LFC = 0
  )

  # Store the result in the list with the treatment names
  result_name_Epi_faecal <- paste(treatment1, "_vs_", treatment2)
  results_list_Epi_faecal[[result_name_Epi_faecal]] <- ALDEx2plot_pairwise
}


saveRDS(results_list_Epi_faecal, "RDS/Epi_faecal_ALDEx_results_list.Rds")

results_list_Epi_faecal <- readRDS("RDS/Epi_faecal_ALDEx_results_list.Rds")

# All data frames in results_list have common columns
common_columns <- c("diff.btw",	"diff.win",	"effect",	"overlap",	"OTU",	"baseMean",	"Kingdom",	"Phylum",	"Class",	"Order",	"Family",	"Genus",	"Species",	"Significance")

# Use purrr to bind the data frames in the results_list
ALDEX_summary_Epi_faecal <- purrr::map_dfr(results_list_Epi_faecal, ~.x[, common_columns], .id = "Comparison")
#ALDEX_summary <- ALDEX_summary %>% filter(Phylum == "NA")

# # Save
write_csv(ALDEX_summary_Epi_faecal, "ANCOM_BC_Table/Epi_faecal_ALDEX_summary.csv")


ALDEX_summary_Epi_faecal %>%
  filter(Significance == "Pass") %>%
  dplyr::select(Comparison, OTU, baseMean, effect, Phylum, Class, Order, Family, Genus) %>%
  arrange(desc(abs(effect))) ->
  ALDEx2plot_pairwise_results_Epi_faecal


# # Save
write_csv(ALDEx2plot_pairwise_results_Epi_faecal, "ANCOM_BC_Table/Epi_faecal_ALDEX_summary_Significant.csv")


# Plot ALDEX plot
# Define the custom order for the "Comparison" variable
custom_order <- c(
  "Sterile feed _vs_ Control",
  "Antibiotics (2X) _vs_ Control",
  "Antibiotics (1X) _vs_ Control",
  "Antibiotics (2X) _vs_ Sterile feed",
  "Antibiotics (1X) _vs_ Sterile feed",
  "Antibiotics (1X) _vs_ Antibiotics (2X)"
)

# Convert "Comparison" to a factor with the custom order
ALDEX_summary_Epi_faecal$Comparison <- factor(ALDEX_summary_Epi_faecal$Comparison, levels = custom_order)


p1_Epi_hindgut <- plot_ALDEx_tax(ALDEX_summary_Epi_faecal,
                 OTU_labels = FALSE,
                 sig_level = significance) +
 facet_wrap(~ Comparison, scales = "free_y")  # Facet by "Comparison"


print(p1_Epi_hindgut)

ggsave("ANCOM_BC_Fig/ALDEX_Epi_faecal.svg", width = 35, height = 25, units = "cm")
```






##**Faeces: Analysis of Compositions of Microbiomes with Bias Correction (ANCOM-BC)**
```{r Epibolus faecal ANCOMBC, cache = T}
# For faeces
Epi_faecal_sub <- filter_ASVs_by_prevalence(ps_obj = Epi_faecal, 
                                             abund_thresh = 2, 
                                             prev_thresh = 2)

sample_data(Epi_faecal_sub)$Treatment <- as.factor(sample_data(Epi_faecal_sub)$Treatment)

sample_data(Epi_faecal_sub)$Treatment <- factor(sample_data(Epi_faecal_sub)$Treatment, levels = c("Control", "Sterile feed", "Antibiotics (2X)", "Antibiotics (1X)"))


# Coerce a phyloseq object to a TreeSummarizedExperiment
tse_Epi_faecal_sub <- makeTreeSummarizedExperimentFromPhyloseq(Epi_faecal_sub)

# Access the metadata slot of the TreeSummarizedExperiment
tse_metadata <- colData(tse_Epi_faecal_sub)

# Update the levels of the Treatment factor in the metadata
tse_metadata$Treatment <- factor(tse_metadata$Treatment,
                                 levels = c("Control", "Sterile feed", "Antibiotics (2X)", "Antibiotics (1X)"))

# Update the metadata in the TreeSummarizedExperiment
colData(tse_Epi_faecal_sub) <- tse_metadata

# You can verify the change by checking:
levels(tse_metadata$Treatment)

phyloseq_to_tse_safe <- function(ps = ps_obj, test_condition = "Density.zone", ref_level = "Light") {
  require(magrittr)
  require(forcats)
  require(phyloseq)

  # critical for ANCOMBC that the reference is the first level!!
  sample_data(ps)[[test_condition]] %<>% fct_relevel(., ref_level)
  mia::makeTreeSummarizedExperimentFromPhyloseq(ps) %>%
    return(.)
}
tse_Epi_faecal_sub <- phyloseq_to_tse_safe(Epi_faecal_sub,
                                            test_condition = "Treatment",
                                            ref_level = "Control")

# Run ANCOM-BC at the genus level and only including the prevalent genera
Epi_faecal_sub_ancombc2 <- ancombc2(data = tse_Epi_faecal_sub,
                   tax_level = "Genus",
                assay_name = "counts",
                fix_formula = "Treatment",
                p_adj_method = "BH",
                group = "Treatment",
                struc_zero = TRUE,
                neg_lb = TRUE,
                n_cl = 70,
                pairwise = TRUE,
                global = TRUE)

saveRDS(Epi_faecal_sub_ancombc2, "RDS/Epi_faecal_sub_ancombc2.Rds")

Epi_faecal_sub_ancombc2 <- readRDS("RDS/Epi_faecal_sub_ancombc2.Rds")




res_prim = Epi_faecal_sub_ancombc2$res

# # Save
write_csv(res_prim, "ANCOM_BC_Table/Epi_faecal_sub_ancombc2.csv")


########################################################## ANCOM-BC2 global test ################################################################

res_global = Epi_faecal_sub_ancombc2$res_global

write_csv(res_global, "ANCOM_BC_Table/Epi_faecal_sub_ancombc2_global.csv")

df_Treatment = res_prim %>%
    dplyr::select(taxon, contains("Treatment")) 
df_fig_global = df_Treatment %>%
    dplyr::left_join(res_global %>%
                       dplyr::transmute(taxon, 
                                        diff_Treatment = diff_abn, 
                                        passed_ss = passed_ss)) %>%
    dplyr::filter(diff_Treatment == 1) %>%
    dplyr::mutate(`lfc_Sterile feed` = `lfc_TreatmentSterile feed`,
                  `lfc_Antibiotics (2X)` = `lfc_TreatmentAntibiotics (2X)`,
                  `lfc_Antibiotics (1X)` = `lfc_TreatmentAntibiotics (1X)`, color = ifelse(passed_ss == 1, "aquamarine3", "black")) %>%
    dplyr::transmute(taxon, 
                     `Sterile feed vs. Control` = round(`lfc_Sterile feed`, 2), 
                     `Antibiotics (2X) vs. Control` = round(`lfc_Antibiotics (2X)`, 2),
                     `Antibiotics (1X) vs. Control` = round(`lfc_Antibiotics (1X)`, 2), color = color) %>%
    tidyr::pivot_longer(cols = `Sterile feed vs. Control`:`Antibiotics (2X) vs. Control`:`Antibiotics (1X) vs. Control`, 
                        names_to = "group", values_to = "value") %>%
    dplyr::arrange(taxon)
  
lo = floor(min(df_fig_global$value))
up = ceiling(max(df_fig_global$value))
mid = (lo + up)/2
fig_global = df_fig_global %>%
  ggplot(aes(x = group, y = taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = "Log fold changes for globally significant taxa") +
  theme_minimal() +
   theme(plot.title = element_text(hjust = 0.5),
  axis.text.y = element_text(color = df_fig_global %>%
                                       dplyr::distinct(taxon, color) %>%
                                       .$color))
fig_global

ggsave("ANCOM_BC_Fig/Epi_faecal_sub_ANCOM-BC2.svg",width = 40, height = 40, units = "cm")





# ANCOM-BC2 multiple pairwise comparisons
res_pair = Epi_faecal_sub_ancombc2$res_pair
write_csv(res_pair, "ANCOM_BC_Table/Epi_faecal_sub_ancombc2_pairwise.csv")

df_fig_pair1 = res_pair %>%
    dplyr::filter(`diff_TreatmentSterile feed` == 1 |
                      `diff_TreatmentAntibiotics (2X)` == 1 | `diff_TreatmentAntibiotics (1X)` == 1 |
                      `diff_TreatmentAntibiotics (2X)_TreatmentSterile feed` == 1 | `diff_TreatmentAntibiotics (1X)_TreatmentSterile feed` == 1
                  | `diff_TreatmentAntibiotics (1X)_TreatmentAntibiotics (2X)` == 1) %>%
    dplyr::mutate(lfc1 = ifelse(`diff_TreatmentSterile feed` == 1, 
                                round(`lfc_TreatmentSterile feed`, 2), 0),
                  lfc2 = ifelse(`diff_TreatmentAntibiotics (2X)` == 1, 
                                round(`lfc_TreatmentAntibiotics (2X)`, 2), 0),
                  lfc3 = ifelse(`diff_TreatmentAntibiotics (1X)` == 1, 
                                round(`lfc_TreatmentAntibiotics (1X)`, 2), 0),
                  lfc4 = ifelse(`diff_TreatmentAntibiotics (2X)_TreatmentSterile feed` == 1, 
                                round(`lfc_TreatmentAntibiotics (2X)_TreatmentSterile feed`, 2), 0),
                  lfc5 = ifelse(`diff_TreatmentAntibiotics (1X)_TreatmentSterile feed` == 1, 
                                round(`lfc_TreatmentAntibiotics (1X)_TreatmentSterile feed`, 2), 0),
                  lfc6 = ifelse(`diff_TreatmentAntibiotics (1X)_TreatmentAntibiotics (2X)` == 1, 
                                round(`lfc_TreatmentAntibiotics (1X)_TreatmentAntibiotics (2X)`, 2), 0)) %>%
    tidyr::pivot_longer(cols = lfc1:lfc6, 
                        names_to = "group", values_to = "value") %>%
    dplyr::arrange(taxon)

df_fig_pair2 = res_pair %>%
    dplyr::filter(`diff_TreatmentSterile feed` == 1 |
                      `diff_TreatmentAntibiotics (2X)` == 1 | `diff_TreatmentAntibiotics (1X)` == 1 |
                      `diff_TreatmentAntibiotics (2X)_TreatmentSterile feed` == 1 | `diff_TreatmentAntibiotics (1X)_TreatmentSterile feed` == 1 | `diff_TreatmentAntibiotics (1X)_TreatmentAntibiotics (2X)` == 1) %>%
    dplyr::mutate(lfc1 = ifelse(`passed_ss_TreatmentSterile feed` == 1 & `diff_TreatmentSterile feed` == 1, 
                                "aquamarine3", "black"),
                  lfc2 = ifelse(`passed_ss_TreatmentAntibiotics (2X)` == 1 & `diff_TreatmentAntibiotics (2X)` == 1, 
                                "aquamarine3", "black"),
                  lfc3 = ifelse(`passed_ss_TreatmentAntibiotics (1X)` == 1 & `diff_TreatmentAntibiotics (1X)` == 1, 
                                "aquamarine3", "black"),
                  lfc4 = ifelse(`passed_ss_TreatmentAntibiotics (2X)_TreatmentSterile feed` == 1 & `diff_TreatmentAntibiotics (2X)_TreatmentSterile feed` == 1, 
                                "aquamarine3", "black"),
                  lfc5 = ifelse(`passed_ss_TreatmentAntibiotics (1X)_TreatmentSterile feed` == 1 & `diff_TreatmentAntibiotics (1X)_TreatmentSterile feed` == 1, 
                                "aquamarine3", "black"),
                  lfc6 = ifelse(`passed_ss_TreatmentAntibiotics (1X)_TreatmentAntibiotics (2X)` == 1 & `diff_TreatmentAntibiotics (1X)_TreatmentAntibiotics (2X)` == 1, 
                                "aquamarine3", "black")) %>%
    tidyr::pivot_longer(cols = lfc1:lfc6, 
                        names_to = "group", values_to = "color") %>%
    dplyr::arrange(taxon)

df_fig_pair = df_fig_pair1 %>%
    dplyr::left_join(df_fig_pair2, by = c("taxon", "group"))

df_fig_pair$group = dplyr::recode(df_fig_pair$group, 
                          `lfc1` = "Sterile feed - Control",
                          `lfc2` = "Antibiotics (2X) - Control",
                          `lfc3` = "Antibiotics (1X) - Control",
                          `lfc4` = "Antibiotics (2X) - Sterile feed",
                          `lfc5` = "Antibiotics (1X) - Sterile feed",
                          `lfc6` = "Antibiotics (1X) - Antibiotics (2X)")
df_fig_pair$group = factor(df_fig_pair$group, 
                          levels = c("Sterile feed - Control",
                                     "Antibiotics (2X) - Control",
                                     "Antibiotics (1X) - Control",
                                     "Antibiotics (2X) - Sterile feed",
                                     "Antibiotics (1X) - Sterile feed",
                                     "Antibiotics (1X) - Antibiotics (2X)"))

lo = floor(min(df_fig_pair$value))
up = ceiling(max(df_fig_pair$value))
mid = (lo + up)/2


fig_pair = df_fig_pair %>%
    ggplot(aes(x = group, y = taxon, fill = value)) + 
    geom_tile(color = "black", linewidth = 0.5) +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                         na.value = "white", midpoint = mid, limit = c(-6, 6),
                         name = NULL) + 
    geom_text(aes(group, taxon, label = value, color = color), size = 7) +
    scale_color_identity(guide = FALSE) +
    labs(x = NULL, y = NULL, title = "Log fold changes as compared to control group") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), axis.text=element_text(size=24), axis.text.x=element_text(size=24, angle = 90, vjust = 0.5, hjust = 1)) 
fig_pair

ggsave("ANCOM_BC_Fig/Epi_faecal_sub_ANCOM-BC2_multiple_pairwise.svg",width = 60, height = 48.2, units = "cm")
```

